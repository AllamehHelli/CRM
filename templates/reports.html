{% extends "base.html" %}
{% block title %}داشبورد گزارش‌گیری{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">داشبورد گزارش‌گیری</h1>
</div>

{% if ai_summary %}
<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="my-0"><i class="bi bi-robot"></i> خلاصه هوشمند تیکت‌ها</h5>
        <small class="text-muted">تولید شده با هوش مصنوعی</small>
    </div>
    <div class="card-body">
        <!-- ما از کتابخانه marked.js برای تبدیل متن Markdown به HTML استفاده می‌کنیم -->
        <div id="ai-summary-content" style="white-space: pre-wrap;">{{ ai_summary | safe }}</div>
    </div>
</div>
{% endif %}


<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('reports') }}">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">از تاریخ</label>
                    <input type="text" name="start_date" class="form-control datepicker" value="{{ start_date }}" autocomplete="off">
                </div>
                <div class="col-md-3">
                    <label class="form-label">تا تاریخ</label>
                    <input type="text" name="end_date" class="form-control datepicker" value="{{ end_date }}" autocomplete="off">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- کارت‌های KPI -->
<div class="row">
    <div class="col-lg-3 col-md-6 mb-4"><div class="card text-white bg-primary shadow h-100"><div class="card-body"><h5 class="card-title">کل تیکت‌ها</h5><p class="card-text fs-2 fw-bold">{{ total_tickets }}</p></div></div></div>
    <div class="col-lg-3 col-md-6 mb-4"><div class="card text-white bg-danger shadow h-100"><div class="card-body"><h5 class="card-title">تیکت‌های باز</h5><p class="card-text fs-2 fw-bold">{{ open_tickets }}</p></div></div></div>
    <div class="col-lg-3 col-md-6 mb-4"><div class="card text-white bg-success shadow h-100"><div class="card-body"><h5 class="card-title">تیکت‌های حل شده</h5><p class="card-text fs-2 fw-bold">{{ closed_tickets }}</p></div></div></div>
    <div class="col-lg-3 col-md-6 mb-4"><div class="card text-white bg-warning shadow h-100"><div class="card-body"><h5 class="card-title">عمر قدیمی‌ترین تیکت باز (روز)</h5><p class="card-text fs-2 fw-bold">{{ oldest_open_ticket_age }}</p></div></div></div>
</div>

<!-- نمودارها -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">روند ایجاد تیکت‌های روزانه</div>
            <div class="card-body"><canvas id="trendChart"></canvas></div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">توزیع تیکت‌ها بر اساس بخش</div>
            <div class="card-body"><canvas id="deptChart"></canvas></div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">توزیع تیکت‌ها بر اساس وضعیت</div>
            <div class="card-body"><canvas id="statusChart"></canvas></div>
        </div>
    </div>
</div>

<!-- جداول عملکرد -->
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">عملکرد مشاوران</div>
            <div class="card-body table-responsive"><table class="table table-sm"><thead><tr><th>نام مشاور</th><th>تیکت ثبت شده</th></tr></thead><tbody>{% for row in counselor_performance %}<tr><td>{{ row.first_name }} {{ row.last_name }}</td><td>{{ row[2] }}</td></tr>{% endfor %}</tbody></table></div>
        </div>
    </div>
    <div class="col-md-8 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">عملکرد بخش‌ها و اپراتورها</div>
            <div class="card-body table-responsive">
                <table class="table table-sm"><thead><tr><th>بخش</th><th>کل تیکت‌ها</th><th>حل شده</th><th>نرخ حل</th></tr></thead><tbody>
                {% for row in department_performance %}<tr><td><strong>{{ row.name }}</strong></td><td>{{ row.total }}</td><td>{{ row.closed or 0 }}</td><td>{{ "%.1f"|format((row.closed or 0) * 100 / row.total) if row.total > 0 else 0.0 }}%</td></tr>{% endfor %}
                </tbody></table>
                <hr>
                <table class="table table-sm table-borderless"><thead><tr><th>اپراتور</th><th>بخش</th><th>تیکت‌های رسیدگی شده</th><th>تیکت‌های حل شده</th></tr></thead><tbody>
                {% for row in operator_performance %}<tr><td>{{ row.first_name }} {{ row.last_name }}</td><td><small>{{ row.name }}</small></td><td>{{ row.total }}</td><td>{{ row.closed or 0 }}</td></tr>{% endfor %}
                </tbody></table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- اضافه کردن کتابخانه Marked.js برای رندر کردن Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    $(document).ready(function() {
        $(".datepicker").persianDatepicker({ format: 'YYYY/MM/DD', autoClose: true, observer: true, initialValue: false });

        // تبدیل متن Markdown خلاصه هوشمند به HTML
        var markdownContent = $('#ai-summary-content').text();
        $('#ai-summary-content').html(marked.parse(markdownContent));

        // ... (بقیه کدهای جاوااسکریپت برای نمودارها بدون تغییر)
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: { labels: {{ trend_labels|tojson }}, datasets: [{ label: 'تیکت‌های ایجاد شده', data: {{ trend_data|tojson }}, borderColor: '#0d6efd', tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        const deptCtx = document.getElementById('deptChart').getContext('2d');
        new Chart(deptCtx, {
            type: 'doughnut',
            data: { labels: {{ dept_chart_labels|tojson }}, datasets: [{ label: 'تعداد تیکت', data: {{ dept_chart_data|tojson }}, backgroundColor: ['#0d6efd', '#6f42c1', '#d63384', '#fd7e14', '#198754', '#dc3545', '#ffc107'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'pie',
            data: { labels: {{ status_chart_labels|tojson }}, datasets: [{ label: 'تعداد تیکت', data: {{ status_chart_data|tojson }}, backgroundColor: ['#6c757d', '#0d6efd', '#198754'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    });
</script>
{% endblock %}
